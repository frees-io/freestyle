<html><head><title>Freestyle: Patterns</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Freestyle: Patterns" /><meta name="og:site_name" content="Freestyle" /><meta name="og:url" content="https://frees-io.github.io/freestyle/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Freestyle: Patterns" /><meta name="twitter:image" content="https://frees-io.github.io/freestyle/img/poster.png" /><meta name="twitter:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/dracula.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/theme-code.css" /><link rel="stylesheet" href="/css/custom.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-18433785-14' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Freestyle</span></div></a></li> <li><a href="/docs/" class="">Quick Start</a></li> <li><a href="/docs/core/" class="">Core Concepts</a> <ul class="sub_section"> <li><a href="/docs/core/algebras/" class="">Algebras</a></li> <li><a href="/docs/core/modules/" class="">Modules</a></li> <li><a href="/docs/core/handlers/" class="">Handlers</a></li> <li><a href="/docs/core/parallelism/" class="">Parallelism</a></li></ul></li> <li><a href="/docs/effects/" class="">Effects</a> <ul class="sub_section"> <li><a href="/docs/effects/error" class="">Error</a></li> <li><a href="/docs/effects/either" class="">Either</a></li> <li><a href="/docs/effects/option" class="">Option</a></li> <li><a href="/docs/effects/reader" class="">Reader</a></li> <li><a href="/docs/effects/writer" class="">Writer</a></li> <li><a href="/docs/effects/state" class="">State</a></li> <li><a href="/docs/effects/traverse" class="">Traverse</a></li> <li><a href="/docs/effects/validation" class="">Validation</a></li> <li><a href="/docs/effects/async" class="">Async Callbacks</a></li></ul></li> <li><a href="/docs/optimizations/" class="">Optimizations</a></li> <li><a href="/docs/stack/" class="">Example Target Stack</a></li> <li><a href="/TODO.html" class=" active ">Patterns</a> <ul class="sub_section"> <li><a href="/docs/effects/Cache/" class="">Cache</a></li> <li><a href="/TODO.html" class="">Dependency Injection</a></li> <li><a href="/docs/patterns/config" class="">Configuration</a></li> <li><a href="/docs/patterns/logging" class="">Logging</a></li></ul></li> <li><a href="/docs/integrations" class="">Integrations</a> <ul class="sub_section"> <li><a href="/docs/integrations/cats" class="">Cats</a></li> <li><a href="/docs/integrations/play" class="">Play Framework</a></li> <li><a href="/docs/integrations/monix" class="">Monix</a></li> <li><a href="/docs/integrations/fetch" class="">Fetch</a></li> <li><a href="/docs/integrations/doobie" class="">Doobie</a></li> <li><a href="/docs/integrations/slick" class="">Slick</a></li> <li><a href="/docs/integrations/akkahttp" class="">Akka HTTP</a></li> <li><a href="/docs/integrations/finch" class="">Finch</a></li> <li><a href="/docs/integrations/http4s" class="">http4s</a></li> <li><a href="/docs/integrations/hammock" class="">Hammock</a></li></ul></li> <li><a href="/docs/rpc" class="">Microservices</a> <ul class="sub_section"> <li><a href="/docs/rpc/quickstart" class="">Quickstart</a></li> <li><a href="/docs/rpc/core-concepts" class="">Core concepts</a></li> <li><a href="/docs/rpc/streaming" class="">Streaming</a></li> <li><a href="/docs/rpc/annotations" class="">Annotations</a></li> <li><a href="/docs/rpc/idl-generation" class="">IDL Generation</a></li> <li><a href="/docs/rpc/patterns" class=" active ">Patterns</a></li> <li><a href="/docs/rpc/ssl-tls" class="">SSL/TLS</a></li> <li><a href="/docs/rpc/metrics-reporting" class="">Metrics Reporting</a></li> <li><a href="/docs/rpc/references" class="">References</a></li></ul></li> <li><a href="/docs/libraries" class="">Libraries</a> <ul class="sub_section"> <li><a href="/docs/effects" class="">Effects</a></li> <li><a href="/docs/cassandra" class="">Cassandra</a></li> <li><a href="/docs/kafka" class="">Kafka</a></li></ul></li> <li><a href="/docs/related/" class="">Related Work</a> <ul class="sub_section"> <li><a href="/docs/related/#bibliography" class="">Bibliography</a></li> <li><a href="/docs/related/#Scala" class="">Scala Libraries</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="frees-io" data-github-repo="freestyle"><div class="content-wrapper"><section><h1 id="patterns">Patterns</h1>

<p>So far so good, not too much code, no business logic, in the previous sections we have seen some protocol definitions with Scala annotations and the generation of IDL files from the Scala definitions. Conversely, in this section, we are going to see how to complete our quickstart example. We’ll take a look at both sides, the server and the client.</p>

<h2 id="server">Server</h2>

<p>Predictably, generating the server code is just implementing a service <a href="http://frees.io/docs/core/interpreters/">Handler</a>.</p>

<p>First of all, our <code class="highlighter-rouge">Greeter</code> RPC protocol definition:</p>

<p>Next, our dummy <code class="highlighter-rouge">Greeter</code> server implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.Async</span>
<span class="k">import</span> <span class="nn">cats.syntax.applicative._</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server.implicits._</span>
<span class="k">import</span> <span class="nn">monix.execution.Scheduler</span>
<span class="k">import</span> <span class="nn">monix.eval.Task</span>
<span class="k">import</span> <span class="nn">monix.reactive.Observable</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">class</span> <span class="nc">ServiceHandler</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Async</span><span class="o">](</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Scheduler</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="n">dummyObservableResponse</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Observable</span><span class="o">.</span><span class="n">fromIterable</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">5</span> <span class="n">map</span> <span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">s</span><span class="s">"Reply $i"</span><span class="o">)))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span> <span class="k">=</span> <span class="s">"Good bye!"</span><span class="o">).</span><span class="n">pure</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">lotsOfReplies</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">dummyObservableResponse</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">lotsOfGreetings</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">request</span>
      <span class="o">.</span><span class="n">foldLeftL</span><span class="o">((</span><span class="mi">0</span><span class="o">,</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="s">""</span><span class="o">)))</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">((</span><span class="n">i</span><span class="o">,</span> <span class="n">response</span><span class="o">),</span> <span class="n">currentRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="k">val</span> <span class="n">currentReply</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">reply</span>
          <span class="o">(</span>
            <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span>
              <span class="n">reply</span> <span class="k">=</span> <span class="n">s</span><span class="s">"$currentReply\nRequest ${currentRequest.greeting} -&gt; Response: Reply $i"</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
      <span class="o">.</span><span class="n">to</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">bidiHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">])</span><span class="k">:</span> <span class="kt">Observable</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">request</span>
      <span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span> <span class="o">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Saving $request..."</span><span class="o">)</span>
        <span class="n">dummyObservableResponse</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="n">onErrorHandle</span> <span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
        <span class="k">throw</span> <span class="n">e</span>
      <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That’s all. We have exposed a potential implementation on the server side.</p>

<h3 id="server-runtime">Server Runtime</h3>

<p>As you can see, the generic handler above requires <code class="highlighter-rouge">F</code> as the type parameter, which corresponds with our target <code class="highlighter-rouge">Monad</code> when interpreting our program. In this section, we will satisfy all the runtime requirements, in order to make our server runnable.</p>

<h3 id="execution-context">Execution Context</h3>

<p>In <a href="https://github.com/frees-io/freestyle-rpc">frees-rpc</a> programs, we’ll at least need an implicit evidence related to the <a href="https://monix.io/">Monix</a> Execution Context: <code class="highlighter-rouge">monix.execution.Scheduler</code>.</p>

<blockquote>
  <p>The <code class="highlighter-rouge">monix.execution.Scheduler</code> is inspired by <code class="highlighter-rouge">ReactiveX</code>, being an enhanced Scala <code class="highlighter-rouge">ExecutionContext</code> and also a replacement for Java’s <code class="highlighter-rouge">ScheduledExecutorService</code>, but also for Javascript’s <code class="highlighter-rouge">setTimeout</code>.</p>
</blockquote>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.execution.Scheduler</span>

<span class="k">trait</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Scheduler</span> <span class="o">=</span> <span class="n">monix</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="nc">Scheduler</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="n">global</span>

<span class="o">}</span>
</code></pre></div></div>

<p>As a side note, <code class="highlighter-rouge">CommonRuntime</code> will also be used later on for the client example program.</p>

<h3 id="runtime-implicits">Runtime Implicits</h3>

<p>For the server bootstrapping, remember adding <code class="highlighter-rouge">frees-rpc-server</code> dependency to your build.</p>

<p>Now, we need to implicitly provide two things:</p>

<ul>
  <li>A runtime interpreter of our <code class="highlighter-rouge">ServiceHandler</code> tied to a specific type. In our case, we’ll use <code class="highlighter-rouge">cats.effects.IO</code>.</li>
  <li>A <code class="highlighter-rouge">ServerW</code> implicit evidence, compounded by:
    <ul>
      <li>RPC port where the server will bootstrap.</li>
      <li>The set of configurations we want to add to our <a href="https://grpc.io/">gRPC</a> server, like our <code class="highlighter-rouge">Greeter</code> service definition. All these configurations are aggregated in a <code class="highlighter-rouge">List[GrpcConfig]</code>. Later on, an internal builder will build the final server based on this list. The full list of exposed settings is available in <a href="https://github.com/frees-io/freestyle-rpc/blob/master/modules/server/src/main/scala/GrpcConfig.scala">this file</a>.</li>
    </ul>
  </li>
</ul>

<p>In summary, the result would be as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.</span><span class="o">~&gt;</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server.handlers._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.async.catsEffect.implicits._</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">object</span> <span class="nc">gserver</span> <span class="o">{</span>

  <span class="k">trait</span> <span class="nc">Implicits</span> <span class="k">extends</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="n">greeterServiceHandler</span><span class="k">:</span> <span class="kt">ServiceHandler</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServiceHandler</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

    <span class="k">val</span> <span class="n">grpcConfigs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">GrpcConfig</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
      <span class="nc">AddService</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="n">bindService</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
    <span class="o">)</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="n">serverW</span><span class="k">:</span> <span class="kt">ServerW</span> <span class="o">=</span> <span class="nc">ServerW</span><span class="o">.</span><span class="n">default</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="n">grpcConfigs</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">implicits</span> <span class="k">extends</span> <span class="nc">Implicits</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Here are a few additional notes related to the previous snippet of code:</p>

<ul>
  <li>The Server will bootstrap on port <code class="highlighter-rouge">8080</code>.</li>
  <li><code class="highlighter-rouge">Greeter.bindService</code> is an auto-derived method which creates, behind the scenes, the binding service for <a href="https://grpc.io/">gRPC</a>. It requires <code class="highlighter-rouge">F[_]</code> as the type parameter, the target/concurrent monad, in our example: <code class="highlighter-rouge">cats.effects.IO</code>.</li>
</ul>

<h3 id="server-bootstrap">Server Bootstrap</h3>

<p>What else is needed? We just need to define a <code class="highlighter-rouge">main</code> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.effect.IO._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server.GrpcServer</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.server.implicits._</span>

<span class="k">object</span> <span class="nc">RPCServer</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">gserver.implicits._</span>

  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
    <span class="n">server</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="n">unsafeRunSync</span><span class="o">()</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Fortunately, once all the runtime requirements are in place (<strong><code class="highlighter-rouge">import gserver.implicits._</code></strong>), we only have to write the previous piece of code, which primarily, should be the same in all cases (except if your target Monad is different from <code class="highlighter-rouge">cats.effects.IO</code>).</p>

<h3 id="service-testing">Service testing</h3>

<p>Thanks to <code class="highlighter-rouge">withServerChannel</code> from the package <code class="highlighter-rouge">freestyle.rpc.testing.servers</code>, you will be able to run in-memory instances of the server, which is very convenient for testing purposes. Below, a very simple property-based test for proving <code class="highlighter-rouge">Greeter.sayHello</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle.rpc.testing.servers.withServerChannel</span>
<span class="k">import</span> <span class="nn">org.scalatest.prop.Checkers</span>
<span class="k">import</span> <span class="nn">org.scalatest._</span>
<span class="k">import</span> <span class="nn">org.scalacheck.Gen</span>
<span class="k">import</span> <span class="nn">org.scalacheck.Prop.forAll</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">class</span> <span class="nc">ServiceSpec</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">Matchers</span> <span class="k">with</span> <span class="nc">Checkers</span> <span class="k">with</span> <span class="nc">OneInstancePerTest</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">gserver.implicits._</span>
  
  <span class="k">def</span> <span class="n">sayHelloTest</span><span class="o">(</span><span class="n">requestGen</span><span class="k">:</span> <span class="kt">Gen</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">],</span> <span class="n">expected</span><span class="k">:</span> <span class="kt">HelloResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">Assertion</span> <span class="o">=</span>
    <span class="n">withServerChannel</span><span class="o">(</span><span class="nc">Greeter</span><span class="o">.</span><span class="n">bindService</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span> <span class="o">{</span> <span class="n">sc</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">Greeter</span><span class="o">.</span><span class="n">clientFromChannel</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">sc</span><span class="o">.</span><span class="n">channel</span><span class="o">)</span>
        <span class="n">check</span> <span class="o">{</span>
          <span class="n">forAll</span><span class="o">(</span><span class="n">requestGen</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
            <span class="n">client</span><span class="o">.</span><span class="n">sayHello</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="n">unsafeRunSync</span><span class="o">()</span> <span class="o">==</span> <span class="n">expected</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

  <span class="k">val</span> <span class="n">requestGen</span><span class="k">:</span> <span class="kt">Gen</span><span class="o">[</span><span class="kt">HelloRequest</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Gen</span><span class="o">.</span><span class="n">alphaStr</span> <span class="n">map</span> <span class="nc">HelloRequest</span>

  <span class="n">test</span><span class="o">(</span><span class="s">"Get a valid response when a proper request is passed"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sayHelloTest</span><span class="o">(</span><span class="n">requestGen</span><span class="o">,</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span> <span class="k">=</span> <span class="s">"Good bye!"</span><span class="o">))</span>
  <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>Running the test:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">run</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServiceSpec</span><span class="o">)</span>
<span class="nc">ServiceSpec</span><span class="k">:</span>
<span class="kt">-</span> <span class="kt">Get</span> <span class="kt">a</span> <span class="kt">valid</span> <span class="kt">response</span> <span class="kt">when</span> <span class="kt">a</span> <span class="kt">proper</span> <span class="kt">request</span> <span class="kt">is</span> <span class="kt">passed</span>
</code></pre></div></div>

<h2 id="client">Client</h2>

<p><a href="https://github.com/frees-io/freestyle-rpc">frees-rpc</a> derives a client automatically based on the protocol. This is especially useful because you can distribute it depending on the protocol/service definitions. If you change something in your protocol definition, you will get a new client for free without having to write anything.</p>

<p>You will need to add either <code class="highlighter-rouge">frees-rpc-client-netty</code> or <code class="highlighter-rouge">frees-rpc-client-okhttp</code> to your build.</p>

<h3 id="client-runtime">Client Runtime</h3>

<p>Similarly in this section, as we saw for the server case, we are defining all the client runtime configurations needed for communication with the server.</p>

<h3 id="execution-context-1">Execution Context</h3>

<p>In our example, we are going to use the same Execution Context described for the Server. However, for the sake of observing a slightly different runtime configuration, our client will be interpreting to <code class="highlighter-rouge">monix.eval.Task</code>. Hence, in this case, we would only need the <code class="highlighter-rouge">monix.execution.Scheduler</code> implicit evidence.</p>

<p>We are going to interpret to <code class="highlighter-rouge">monix.eval.Task</code>, however, behind the scenes, we will use the <a href="https://github.com/typelevel/cats-effect">cats-effect</a> <code class="highlighter-rouge">IO</code> monad as an abstraction. Concretely, Freestyle has an integration with <code class="highlighter-rouge">cats-effect</code> that is included transitively in the classpath through <code class="highlighter-rouge">frees-async-cats-effect</code> dependency.</p>

<h3 id="runtime-implicits-1">Runtime Implicits</h3>

<p>First of all, we need to configure how the client will reach the server in terms of the transport layer. There are two supported methods:</p>

<ul>
  <li>By Address (host/port): brings the ability to create a channel with the target’s address and port number.</li>
  <li>By Target: it can create a channel with a target string, which can be either a valid <a href="https://grpc.io/grpc-java/javadoc/io/grpc/NameResolver.html">NameResolver</a>-compliant URI or an authority string.</li>
</ul>

<p>Additionally, we can add more optional configurations that can be used when the connection is occurring. All the options are available <a href="https://github.com/frees-io/freestyle-rpc/blob/6b0e926a5a14fbe3d9282e8c78340f2d9a0421f3/rpc/src/main/scala/client/ChannelConfig.scala#L33-L46">here</a>. As we will see shortly in our example, we are going to skip the negotiation (<code class="highlighter-rouge">UsePlaintext()</code>).</p>

<p>Given the transport settings and a list of optional configurations, we can create the <a href="https://grpc.io/grpc-java/javadoc/io/grpc/ManagedChannel.html">ManagedChannel.html</a> object, using the <code class="highlighter-rouge">ManagedChannelInterpreter</code> builder.</p>

<p>So, taking into account all we have just said, how would our code look?</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">freestyle.free.config.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.async.catsEffect.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.client._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.client.config._</span>
<span class="k">import</span> <span class="nn">freestyle.rpc.client.implicits._</span>
<span class="k">import</span> <span class="nn">monix.eval.Task</span>
<span class="k">import</span> <span class="nn">io.grpc.ManagedChannel</span>
<span class="k">import</span> <span class="nn">service._</span>

<span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Failure</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">gclient</span> <span class="o">{</span>

  <span class="k">trait</span> <span class="nc">Implicits</span> <span class="k">extends</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">channelFor</span><span class="k">:</span> <span class="kt">ChannelFor</span> <span class="o">=</span>
      <span class="nc">ConfigForAddress</span><span class="o">[</span><span class="kt">Try</span><span class="o">](</span><span class="s">"rpc.host"</span><span class="o">,</span> <span class="s">"rpc.port"</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">c</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="o">()</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"Unable to load the client configuration"</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="n">serviceClient</span><span class="k">:</span> <span class="kt">Greeter.Client</span><span class="o">[</span><span class="kt">Task</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">Greeter</span><span class="o">.</span><span class="n">client</span><span class="o">[</span><span class="kt">Task</span><span class="o">](</span><span class="n">channelFor</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">implicits</span> <span class="k">extends</span> <span class="nc">Implicits</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Notes</strong>:</p>

<ul>
  <li><code class="highlighter-rouge">host</code> and <code class="highlighter-rouge">port</code> would be read from the application configuration file.</li>
  <li>To be able to use the <code class="highlighter-rouge">ConfigForAddress</code> helper, you need to add the <code class="highlighter-rouge">frees-rpc-config</code> dependency to your build.</li>
</ul>

<h3 id="client-program">Client Program</h3>

<p>Once we have our runtime configuration defined as above, everything gets easier. This is an example of a client application, following our dummy quickstart:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">service._</span>
<span class="k">import</span> <span class="nn">gclient.implicits._</span>
<span class="k">import</span> <span class="nn">monix.eval.Task</span>

<span class="k">import</span> <span class="nn">scala.concurrent.Await</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span>

<span class="k">object</span> <span class="nc">RPCDemoApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">serviceClient</span><span class="o">.</span><span class="n">sayHello</span><span class="o">(</span><span class="nc">HelloRequest</span><span class="o">(</span><span class="s">"foo"</span><span class="o">)).</span><span class="n">runAsync</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="nc">Inf</span><span class="o">)</span>

    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Result = $result"</span><span class="o">)</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/freestyle'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>