<html><head><title>Freestyle</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Freestyle" /><meta name="og:site_name" content="Freestyle" /><meta name="og:url" content="https://frees-io.github.io/freestyle/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Freestyle" /><meta name="twitter:image" content="https://frees-io.github.io/freestyle/img/poster.png" /><meta name="twitter:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="twitter:card" content="summary_large_image" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-18433785-14' , 'auto');
ga('send', 'pageview');
      </script><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/dracula.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/kazari-style.css" /><link rel="stylesheet" href="/css/monokai.css" /><link rel="stylesheet" href="/css/custom.css" /><link rel="stylesheet" href="/css/theme-code.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Freestyle</span></div></a></li> <li><a href="/docs/" class="">Quick Start</a></li> <li><a href="/docs/core/" class="">Core Concepts</a> <ul class="sub_section"> <li><a href="/docs/core/algebras/" class="">Algebras</a></li> <li><a href="/docs/core/modules/" class="">Modules</a></li> <li><a href="/docs/core/handlers/" class="">Handlers</a></li> <li><a href="/docs/core/parallelism/" class=" active ">Parallelism</a></li> <li><a href="/docs/core/tagless/" class="">Tagless Final</a></li></ul></li> <li><a href="/docs/effects/" class="">Effects</a> <ul class="sub_section"> <li><a href="/docs/effects/error" class="">Error</a></li> <li><a href="/docs/effects/either" class="">Either</a></li> <li><a href="/docs/effects/option" class="">Option</a></li> <li><a href="/docs/effects/reader" class="">Reader</a></li> <li><a href="/docs/effects/writer" class="">Writer</a></li> <li><a href="/docs/effects/state" class="">State</a></li> <li><a href="/docs/effects/traverse" class="">Traverse</a></li> <li><a href="/docs/effects/validation" class="">Validation</a></li> <li><a href="/docs/effects/async" class="">Async Callbacks</a></li></ul></li> <li><a href="/docs/optimizations/" class="">Optimizations</a></li> <li><a href="/docs/stack/" class="">Example Target Stack</a></li> <li><a href="/TODO.html" class="">Patterns</a> <ul class="sub_section"> <li><a href="/docs/effects/Cache/" class="">Cache</a></li> <li><a href="/TODO.html" class="">Dependency Injection</a></li> <li><a href="/docs/patterns/config" class="">Configuration</a></li> <li><a href="/docs/patterns/logging" class="">Logging</a></li></ul></li> <li><a href="/docs/integrations" class="">Integrations</a> <ul class="sub_section"> <li><a href="/docs/integrations/cats" class="">Cats</a></li> <li><a href="/docs/integrations/play" class="">Play Framework</a></li> <li><a href="/docs/integrations/monix" class="">Monix</a></li> <li><a href="/docs/integrations/fetch" class="">Fetch</a></li> <li><a href="/docs/integrations/doobie" class="">Doobie</a></li> <li><a href="/docs/integrations/slick" class="">Slick</a></li> <li><a href="/docs/integrations/akkahttp" class="">Akka HTTP</a></li> <li><a href="/docs/integrations/finch" class="">Finch</a></li> <li><a href="/docs/integrations/http4s" class="">http4s</a></li></ul></li> <li><a href="/docs/related/" class="">Related Work</a> <ul class="sub_section"> <li><a href="/docs/related/#bibliography" class="">Bibliography</a></li> <li><a href="/docs/related/#Scala" class="">Scala Libraries</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="frees-io" data-github-repo="freestyle"><div class="content-wrapper"><section><h1 id="parallelism-and-non-determinism">Parallelism and non-determinism</h1>

<p>Freestyle supports building programs that support both sequential and parallel computations.</p>

<h1 id="rationale">Rationale</h1>

<p>One of the biggest issues with architectures based on Free monads is that, by default ,<code class="highlighter-rouge">cats.free.Free</code> does not support parallelism since your actions as described as a series of sequential monadic steps. Each computation step is built with <code class="highlighter-rouge">Free#flatMap</code> and evaluated via <code class="highlighter-rouge">Free#foldMap</code>.
This is not an issue when your operations produce an output value and that value is used as the input in the next step in the monadic sequence, but it’s rather hard to express computations that may be performed in parallel.</p>

<h1 id="hinting-parallelization">Hinting Parallelization</h1>

<p>As you may have noticed by now, Freestyle uses a type alias as a return type for operations called <code class="highlighter-rouge">FreeS</code>.
FreeS is an alias for a Free monad that represents a sequential fragment of potentially multiple parallel steps.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">type</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">FreeApplicative</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>
</code></pre>
</div>

<p>We use <code class="highlighter-rouge">FreeS.Par</code> as an alias for <code class="highlighter-rouge">FreeApplicative</code> to denote functions that represent a potential parallel step.</p>

<p>Independent operations that can potentially be executed in parallel can be placed inside <code class="highlighter-rouge">@free</code> algebras as abstract definitions like in the example below:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle._</span>
<span class="c1">// import freestyle._
</span>
<span class="nd">@free</span> <span class="k">trait</span> <span class="nc">Validation</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">minSize</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">hasNumber</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
<span class="o">}</span>
<span class="c1">// defined trait Validation
// defined object Validation
</span></code></pre>
</div>

<h1 id="parallel-interpretation">Parallel interpretation</h1>

<p>Handlers for operations that are executed in parallel should target a type for which there is a monad instance that supports parallelism.
Freestyle ships with ready to use instances for <code class="highlighter-rouge">scala.concurrent.Future</code> and contains extension modules for <a href="https://monix.io/docs/2x/eval/task.html"><code class="highlighter-rouge">monix.eval.Task</code></a> and <a href="http://akka.io/"><code class="highlighter-rouge">akka actors</code></a>. (WIP)</p>

<p>To enable these instances and support parallelism you need to explicitly import:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle.nondeterminism._</span>
<span class="c1">// import freestyle.nondeterminism._
</span></code></pre>
</div>

<p>The code below illustrates a handler that will allow parallel executions thanks to the unsafe nature of <code class="highlighter-rouge">scala.concurrent.Future#apply</code> which runs immediately:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Kleisli</span>
<span class="c1">// import cats.data.Kleisli
</span>
<span class="k">import</span> <span class="nn">cats.syntax.apply._</span>
<span class="c1">// import cats.syntax.apply._
</span>
<span class="k">import</span> <span class="nn">scala.concurrent.Future</span>
<span class="c1">// import scala.concurrent.Future
</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="c1">// import scala.concurrent.duration._
</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="c1">// import scala.concurrent.ExecutionContext.Implicits.global
</span>
<span class="k">type</span> <span class="kt">ParValidator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">String</span>, <span class="kt">A</span><span class="o">]</span>
<span class="c1">// defined type alias ParValidator
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">interpreter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Validation</span><span class="o">.</span><span class="nc">Handler</span><span class="o">[</span><span class="kt">ParValidator</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">minSize</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">ParValidator</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Kleisli</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">hasNumber</span><span class="k">:</span> <span class="kt">ParValidator</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Kleisli</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="s">"0123456789"</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">c</span><span class="o">))))</span>
<span class="o">}</span>
<span class="c1">// interpreter: Validation.Handler[ParValidator] = $anon$1@29fb1f24
</span>
<span class="k">val</span> <span class="n">validation</span> <span class="k">=</span> <span class="nc">Validation</span><span class="o">[</span><span class="kt">Validation.Op</span><span class="o">]</span>
<span class="c1">// validation: Validation[Validation.Op] = Validation$To@8f49b02
</span>
<span class="k">import</span> <span class="nn">validation._</span>
<span class="c1">// import validation._
</span>
<span class="k">val</span> <span class="n">parValidation</span> <span class="k">=</span> <span class="o">(</span><span class="n">minSize</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">hasNumber</span><span class="o">).</span><span class="n">mapN</span><span class="o">(</span><span class="k">_</span> <span class="o">::</span> <span class="k">_</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">)</span>
<span class="c1">// parValidation: validation.FS[List[Boolean]] = FreeApplicative(...)
</span>
<span class="k">val</span> <span class="n">validator</span> <span class="k">=</span> <span class="n">parValidation</span><span class="o">.</span><span class="n">interpret</span><span class="o">[</span><span class="kt">ParValidator</span><span class="o">]</span>
<span class="c1">// validator: ParValidator[List[Boolean]] = Kleisli(cats.data.Kleisli$$Lambda$8546/1466829256@1dd9819a)
</span>
<span class="c1">//validator.run("abc1") runs each op in parallel and returns the result in a Future
</span></code></pre>
</div>

<h1 id="mixing-sequential-and-parallel-computations">Mixing sequential and parallel computations</h1>

<p>Sequential and parallel actions can be easily intermixed in <code class="highlighter-rouge">@free</code> algebras:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nd">@free</span> <span class="k">trait</span> <span class="nc">MixedFreeS</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">x</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">y</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">z</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="o">}</span>
<span class="c1">// defined trait MixedFreeS
// defined object MixedFreeS
</span></code></pre>
</div>

<p>Using the <a href="http://eed3si9n.com/herding-cats/Cartesian.html#The+Applicative+Style">cats cartesian builder operator |@|</a> we can easily describe steps that run in parallel:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">program</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">M</span><span class="k">:</span> <span class="kt">MixedFreeS</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">M._</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">a</span> <span class="k">&lt;-</span> <span class="n">z</span> <span class="c1">//3
</span>    <span class="n">bc</span> <span class="k">&lt;-</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">).</span><span class="n">tupled</span><span class="o">.</span><span class="n">freeS</span>
    <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="k">=</span> <span class="n">bc</span>
    <span class="n">d</span> <span class="k">&lt;-</span> <span class="n">z</span> <span class="c1">//3
</span>  <span class="o">}</span> <span class="k">yield</span> <span class="nc">List</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// program: [F[_]](implicit M: MixedFreeS[F])cats.free.Free[[β$0$]cats.free.FreeApplicative[F,β$0$],List[Int]]
</span></code></pre>
</div>

<p>Once our operations run in parallel, we can join the results back into the monadic flow lifting it with <code class="highlighter-rouge">.freeS</code>.
In practice, you may not need to use <code class="highlighter-rouge">.freeS</code> since Freestyle supports an implicit conversion to lift those automatically so, if the return type is properly inferred you may omit <code class="highlighter-rouge">.freeS</code> altogether.</p>

<p><code class="highlighter-rouge">FreeS.Par#freeS</code> is a function enriched into the <code class="highlighter-rouge">FreeApplicative</code> syntax that joins the result of both operations back
into a free monad step whose result can be used in further monadic computation.</p>

<p>Now that we’ve covered how to build modular programs that support both sequential and parallel style computations, let’s explore some of the <a href="../../effects">extra freestyle integrations and effects</a>.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/js/animations.js"></script><script src="/js/anime.min.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/freestyle'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script><script src="/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>